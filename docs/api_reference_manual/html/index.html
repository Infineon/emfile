<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SEGGER emFile for ModusToolbox</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="https://www.infineon.com"><img alt="Logo" src="logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SEGGER emFile for ModusToolbox</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">SEGGER emFile for ModusToolbox User Guide </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="section_general"></a>
General Description</h1>
<p ><a href="https://www.segger.com/products/file-system/emfile">emFile</a> is a fail-safe filesystem designed for embedded systems by SEGGER Microcontroller GmbH that can be used with different types of storage devices. It is a high-performance library optimized for high speed, versatility, and a minimal memory footprint of both RAM and ROM. Infineon has licensed emFile from SEGGER and offers it for free to its customers. This middleware library provides emFile in the form of pre-built libraries and supports FAT 12/16/32 file systems.</p>
<h1><a class="anchor" id="section_quick_start"></a>
Quick Start</h1>
<p >The Quick Start Guide section has simple examples for the NOR flash and Memory Card Device drivers. Examples are used to initialize the file system on the target memory, demonstrate the creation/opening file, and update its content.</p>
<h2><a class="anchor" id="section_qsg_project_creation"></a>
Project creation</h2>
<ol type="1">
<li>Create an empty application using the Project Creator tool in the ModusToolbox&trade; software.</li>
<li>Add the <a href="https://github.com/Infineon/emfile">emfile</a> and <a href="https://github.com/Infineon/retarget-io">retarget-io</a> libraries using the Library Manager.</li>
<li>To run an example in the RTOS-environment, add the <a href="https://github.com/Infineon/freertos">FreeRTOS</a> library using the Library Manager. Then, add <em>RTOS_AWARE</em> and <em>FREERTOS</em> to the Makefile COMPONENTS variable. <div class="fragment"><div class="line">COMPONENTS += RTOS_AWARE FREERTOS </div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>In the RTOS environment, select Active mode for System Idle Power Mode in Power personality (System Tab).</dd></dl>
<em>The next steps are applicable only for the NOR flash driver</em></li>
<li>To use the same storage for code execution and File System, do additional steps. Refer to the <a class="el" href="index.html#section_nor_driver_xip">XIP support</a> section.</li>
</ol>
<h2><a class="anchor" id="section_qsg_project_dev_conf"></a>
HW Configuration in Device Configurator</h2>
<p >All HW resources used in this QSG must be configured in the Device Configurator:</p><ul>
<li>UART for logging</li>
<li>One pin to check the button status</li>
<li>Memory Card Device HW - SDHC</li>
<li>NOR flash HW - SMIF</li>
</ul>
<p >If a different alias name is selected instead of the expected resources name in the Device Configurator, the code snippets must be updated.</p>
<table class="doxtable">
<tr>
<th>Resource</th><th>Name </th></tr>
<tr>
<td>Quad Serial Memory Interface </td><td>SMIF_EMFILE  </td></tr>
<tr>
<td>SD Host Controller </td><td>SDHC_EMFILE  </td></tr>
<tr>
<td>Serial Communication Block (for debug UART) </td><td>DEBUG_UART  </td></tr>
<tr>
<td>Pin </td><td>CYBSP_USER_BTN  </td></tr>
</table>
<p ><em>Recommended Memory Card Device configuration</em> </p><div class="image">
<img src="emfile_sd_card_cat1d.png" alt=""/>
</div>
<p ><em>Recommended SMIF configuration</em> </p><div class="image">
<img src="emfile_smif_cat1d.png" alt=""/>
</div>
<p ><em>Recommended Debug UART</em> </p><div class="image">
<img src="emfile_debug_uart_part1_cat1d.png" alt=""/>
</div>
 <div class="image">
<img src="emfile_debug_uart_part2_cat1d.png" alt=""/>
</div>
<p ><em>Recommended Button Pin configuration</em> </p><div class="image">
<img src="emfile_user_btn_cat1d.png" alt=""/>
</div>
<h2><a class="anchor" id="section_qsg_main"></a>
Add emFile logic to main.c</h2>
<p ><b>Specific steps for SPI flash driver configuration</b></p><ol type="1">
<li>Include the required headers. <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;mtb_hal_memoryspi.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cy_sysint.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cy_smif.h&quot;</span></div>
</div><!-- fragment --></li>
<li>Add global variables. <div class="fragment"><div class="line"><span class="keyword">static</span> mtb_hal_memoryspi_t * memspi_obj_ptr;</div>
<div class="line"><span class="keyword">static</span> cy_stc_smif_context_t memspi_context;</div>
</div><!-- fragment --></li>
<li>AAdd the interrupt handler for NOR flash HW. <div class="fragment"><div class="line"><span class="keywordtype">void</span> nor_isr(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    mtb_hal_memoryspi_process_interrupt(memspi_obj_ptr);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add the function for initialization NOR flash HW. <div class="fragment"><div class="line"><span class="keywordtype">void</span> FS_NOR_HW_SPIFI_ConfigureHw(mtb_hal_memoryspi_t * memspi_obj)</div>
<div class="line">{</div>
<div class="line">    cy_rslt_t hal_status;</div>
<div class="line">    cy_en_smif_status_t pdl_smif_status;</div>
<div class="line">    cy_en_sysint_status_t  pdl_sysint_status;</div>
<div class="line"> </div>
<div class="line">    memspi_obj_ptr = memspi_obj;</div>
<div class="line"> </div>
<div class="line">    pdl_smif_status = Cy_SMIF_Init(SMIF_EMFILE_HW, SMIF_EMFILE_hal_config.config, 10000UL, &amp;memspi_context);</div>
<div class="line">    <span class="keywordflow">if</span> (CY_RSLT_SUCCESS != pdl_smif_status)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Cy_SMIF_Init returns error status\n\r&quot;</span>);</div>
<div class="line">        CY_ASSERT(0U);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* HAL setup */</span></div>
<div class="line">    hal_status = mtb_hal_memoryspi_setup(memspi_obj_ptr, &amp;SMIF_EMFILE_hal_config, &amp;memspi_context);</div>
<div class="line">    <span class="keywordflow">if</span> (CY_RSLT_SUCCESS != hal_status)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;mtb_hal_memoryspi_setup returns error status\n\r&quot;</span>);</div>
<div class="line">        CY_ASSERT(0U);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    cy_stc_sysint_t nor_isr_config =</div>
<div class="line">    {</div>
<div class="line">        .intrSrc = SMIF_EMFILE_IRQ,</div>
<div class="line">        .intrPriority = 3U</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    pdl_sysint_status = Cy_SysInt_Init(&amp;nor_isr_config, nor_isr);</div>
<div class="line">    <span class="keywordflow">if</span> (CY_SYSINT_SUCCESS != pdl_sysint_status)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Cy_SysInt_Init returns error status\n\r&quot;</span>);</div>
<div class="line">        CY_ASSERT(0U);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    NVIC_EnableIRQ((IRQn_Type) nor_isr_config.intrSrc);</div>
<div class="line"> </div>
<div class="line">    Cy_SMIF_SetDataSelect(SMIF_EMFILE_HW, (memspi_obj_ptr-&gt;chip_select), CY_SMIF_DATA_SEL0);</div>
<div class="line">    Cy_SMIF_Enable(SMIF_EMFILE_HW, memspi_obj_ptr-&gt;context);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add <em>EMFILE_NOR_FLASH</em> to COMPONENTS variable in the Makefile. <div class="fragment"><div class="line">COMPONENTS += EMFILE_NOR_FLASH </div>
</div><!-- fragment --></li>
</ol>
<p ><b>Specific steps for the Memory Card Device driver configuration</b></p><ol type="1">
<li>Include the required headers. <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;mtb_hal_sdhc.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cy_sd_host.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cy_sysint.h&quot;</span></div>
</div><!-- fragment --></li>
<li>Add global variables. <div class="fragment"><div class="line"><span class="keyword">static</span> mtb_hal_sdhc_t * sdhc_obj_ptr;</div>
<div class="line"><span class="keyword">static</span> cy_stc_sd_host_context_t sdhc_host_context;</div>
</div><!-- fragment --></li>
<li>Add the interrupt handler for Memory Card Device HW. <div class="fragment"><div class="line"><span class="keywordtype">void</span> sd_card_isr(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    mtb_hal_sdhc_process_interrupt(sdhc_obj_ptr);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add the Cy_SD_Host_IsCardConnected() function <div class="fragment"><div class="line"><span class="keywordtype">bool</span> Cy_SD_Host_IsCardConnected(SDHC_Type <span class="keyword">const</span> *base)</div>
<div class="line">{</div>
<div class="line">    (void) base;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add the function for the Memory Card Device HW initialization. <div class="fragment"><div class="line"><span class="keywordtype">void</span> FS_MMC_HW_CM_ConfigureHw(mtb_hal_sdhc_t * sdhc_obj)</div>
<div class="line">{</div>
<div class="line">    cy_rslt_t hal_status;</div>
<div class="line">    cy_en_sd_host_status_t pdl_sdhc_status;</div>
<div class="line">    cy_en_sysint_status_t  pdl_sysint_status;</div>
<div class="line"> </div>
<div class="line">    sdhc_obj_ptr = sdhc_obj;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* The SD Card should be enabled before calling any other SD Card APIs */</span></div>
<div class="line">    Cy_SD_Host_Enable(SDHC_EMFILE_HW);</div>
<div class="line"> </div>
<div class="line">    pdl_sdhc_status = Cy_SD_Host_Init(SDHC_EMFILE_HW, &amp;SDHC_EMFILE_config, &amp;sdhc_host_context);</div>
<div class="line">    <span class="keywordflow">if</span> (CY_SD_HOST_SUCCESS != pdl_sdhc_status)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Cy_SD_Host_Init returns error status\n\r&quot;</span>);</div>
<div class="line">        CY_ASSERT(0U);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    pdl_sdhc_status = Cy_SD_Host_InitCard(SDHC_EMFILE_HW, &amp;SDHC_EMFILE_card_cfg, &amp;sdhc_host_context);</div>
<div class="line">    <span class="keywordflow">if</span> (CY_SD_HOST_SUCCESS != pdl_sdhc_status)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Cy_SD_Host_InitCard returns error status\n\r&quot;</span>);</div>
<div class="line">        CY_ASSERT(0U);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    hal_status = mtb_hal_sdhc_setup(sdhc_obj_ptr, &amp;SDHC_EMFILE_sdhc_hal_config, NULL, &amp;sdhc_host_context);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (CY_RSLT_SUCCESS != hal_status)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;mtb_hal_sdhc_setup returns error status\n\r&quot;</span>);</div>
<div class="line">        CY_ASSERT(0U);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    cy_stc_sysint_t sdhc_isr_config =</div>
<div class="line">    {</div>
<div class="line">        .intrSrc = SDHC_EMFILE_IRQ,</div>
<div class="line">        .intrPriority = 3U</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    pdl_sysint_status = Cy_SysInt_Init(&amp;sdhc_isr_config, sd_card_isr);</div>
<div class="line">    <span class="keywordflow">if</span> (CY_SYSINT_SUCCESS != pdl_sysint_status)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Cy_SysInt_Init returns error status\n\r&quot;</span>);</div>
<div class="line">        CY_ASSERT(0U);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    NVIC_EnableIRQ((IRQn_Type) sdhc_isr_config.intrSrc);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add <em>EMFILE_SD_CARD</em> to COMPONENTS variable in the Makefile. <div class="fragment"><div class="line">COMPONENTS += EMFILE_SD_CARD </div>
</div><!-- fragment --></li>
</ol>
<p ><b>Common code</b></p><ol type="1">
<li>Include the required headers. <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;cybsp.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cy_retarget_io.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;mtb_hal_gpio.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;mtb_hal_system.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;FS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined(COMPONENT_RTOS_AWARE)</span></div>
<div class="line"><span class="comment">/* FreeRTOS headers */</span></div>
<div class="line"><span class="preprocessor">#include &quot;FreeRTOS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;task.h&quot;</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* #if defined(COMPONENT_RTOS_AWARE) */</span><span class="preprocessor"></span></div>
</div><!-- fragment --></li>
<li>Add the common define to the project. <div class="fragment"><div class="line"><span class="comment">/* Last byte in the buffer is used for terminating the string using a NULL</span></div>
<div class="line"><span class="comment"> * character. Therefore, the number of bytes read from the file is one less than</span></div>
<div class="line"><span class="comment"> * the value of the macro.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define NUM_BYTES_TO_READ_FROM_FILE         (256U)</span></div>
<div class="line"><span class="preprocessor">#define STRING_TO_WRITE                     &quot;This is an emFile filesystem example for ModusToolbox.&quot;</span></div>
<div class="line"><span class="preprocessor">#define FILE_NAME                           &quot;File.txt&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined(COMPONENT_RTOS_AWARE)</span></div>
<div class="line"><span class="preprocessor">#define EMFILE_TASK_STACK_SIZE              (512U)</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* #if defined(COMPONENT_RTOS_AWARE) */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Debounce delay for the user button. */</span></div>
<div class="line"><span class="preprocessor">#define DEBOUNCE_DELAY_MS                   (50U)</span></div>
</div><!-- fragment --></li>
<li>Add common global variables. <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> fileData[NUM_BYTES_TO_READ_FROM_FILE];</div>
<div class="line"><span class="keyword">static</span> mtb_hal_gpio_t button_obj;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined(COMPONENT_RTOS_AWARE)</span></div>
<div class="line"><span class="keyword">static</span> TaskHandle_t emfile_task_handle;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> button_press = <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* #if defined(COMPONENT_RTOS_AWARE) */</span><span class="preprocessor"></span></div>
</div><!-- fragment --></li>
<li>Add the function prototypes. <div class="fragment"><div class="line"><span class="comment">/* Callback function prototype for user button, required by</span></div>
<div class="line"><span class="comment"> * user_button_callback_data structure</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> user_button_callback(<span class="keywordtype">void</span> *handler_arg, mtb_hal_gpio_event_t event);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> check_error(<span class="keywordtype">char</span> *message, <span class="keywordtype">int</span> error);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> btn_init(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="comment">/* Implemented in separate file */</span></div>
<div class="line"><span class="keywordtype">void</span> retarget_io_init(<span class="keywordtype">void</span>);</div>
</div><!-- fragment --></li>
<li>Add the emFile task function. <div class="fragment"><div class="line"><span class="keywordtype">void</span> emfile_task(<span class="keywordtype">void</span>* arg)</div>
<div class="line">{</div>
<div class="line">    U32         varU32;</div>
<div class="line">    U32         numBytesToRead;</div>
<div class="line">    <span class="keywordtype">int</span>         error;</div>
<div class="line">    FS_FILE    *filePtr;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *volumeName = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    (void) arg;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Initialize button */</span></div>
<div class="line">    btn_init();</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined (COMPONENT_EMFILE_NOR_FLASH)</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;Using NOR flash as storage device\n&quot;</span>);</div>
<div class="line"><span class="preprocessor">#else </span><span class="comment">/* COMPONENT_EMFILE_SD_CARD */</span><span class="preprocessor"></span></div>
<div class="line">    printf(<span class="stringliteral">&quot;Using SD card as storage device\n&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* #if defined (COMPONENT_EMFILE_NOR_FLASH) */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Initialize the file system. */</span></div>
<div class="line">    FS_Init();</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined (COMPONENT_EMFILE_NOR_FLASH)</span></div>
<div class="line">    <span class="comment">/* Check if low-level format is required. Applicable only for NOR flash. */</span></div>
<div class="line">    error = FS_FormatLLIfRequired(volumeName);</div>
<div class="line">    check_error(<span class="stringliteral">&quot;Error in low-level formatting&quot;</span>, error);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* #if defined (COMPONENT_EMFILE_NOR_FLASH) */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Check if volume needs to be high-level formatted. */</span></div>
<div class="line">    error = FS_IsHLFormatted(volumeName);</div>
<div class="line">    check_error(<span class="stringliteral">&quot;Error in checking if volume is high-level formatted&quot;</span>, error);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Return value of 0 indicates that high-level format is required. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (error == 0)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Perform high-level format\n&quot;</span>);</div>
<div class="line">        error = FS_Format(volumeName, NULL);</div>
<div class="line">        check_error(<span class="stringliteral">&quot;Error in high-level formatting&quot;</span>, error);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    varU32 = FS_GetVolumeSizeKB(volumeName);</div>
<div class="line">    printf(<span class="stringliteral">&quot;Volume size: %&quot;</span>PRIu32<span class="stringliteral">&quot; KB\n\n&quot;</span>, varU32);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(0U == varU32)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Error in checking the volume size\n&quot;</span>);</div>
<div class="line">        CY_ASSERT(0U);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;Opening the file for reading...\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Open the file for reading. */</span></div>
<div class="line">    filePtr = FS_FOpen(FILE_NAME, <span class="stringliteral">&quot;r&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (filePtr != NULL)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Last byte is for storing the NULL character. */</span></div>
<div class="line">        numBytesToRead = <span class="keyword">sizeof</span>(fileData) - 1U;</div>
<div class="line">        varU32 = FS_GetFileSize(filePtr);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(varU32 &lt; numBytesToRead)</div>
<div class="line">        {</div>
<div class="line">            numBytesToRead = varU32;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;Reading %&quot;</span>PRIu32<span class="stringliteral">&quot; bytes from the file. &quot;</span>, numBytesToRead);</div>
<div class="line">        varU32 = FS_Read(filePtr, fileData, numBytesToRead);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(varU32 != numBytesToRead)</div>
<div class="line">        {</div>
<div class="line">            error = FS_FError(filePtr);</div>
<div class="line">            check_error(<span class="stringliteral">&quot;Error in reading from the file&quot;</span>, error);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">/* Terminate the string using NULL. */</span></div>
<div class="line">        fileData[numBytesToRead] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Display the file content. */</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;File Content:\n\&quot;%s\&quot;\n&quot;</span>, fileData);</div>
<div class="line"> </div>
<div class="line">        error = FS_FClose(filePtr);</div>
<div class="line">        check_error(<span class="stringliteral">&quot;Error in closing the file&quot;</span>, error);</div>
<div class="line">        </div>
<div class="line">        printf(<span class="stringliteral">&quot;\nOpening the file for overwriting...\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to read. File not found.\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\nOpening the file for writing...\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Mode &#39;w&#39; truncates the file size to zero if the file exists otherwise</span></div>
<div class="line"><span class="comment">     * creates a new file.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    filePtr = FS_FOpen(FILE_NAME, <span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(filePtr != NULL)</div>
<div class="line">    {</div>
<div class="line">        varU32 = FS_Write(filePtr, STRING_TO_WRITE, strlen(STRING_TO_WRITE));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>(varU32 != strlen(STRING_TO_WRITE))</div>
<div class="line">        {</div>
<div class="line">            error = FS_FError(filePtr);</div>
<div class="line">            check_error(<span class="stringliteral">&quot;Error in writing to the file&quot;</span>, error);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;File is written with the following message:\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\&quot;%s\&quot;\n\n&quot;</span>, STRING_TO_WRITE);</div>
<div class="line"> </div>
<div class="line">        error = FS_FClose(filePtr);</div>
<div class="line">        check_error(<span class="stringliteral">&quot;Error in closing the file&quot;</span>, error);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Enable the user button interrupt */</span></div>
<div class="line">        mtb_hal_gpio_enable_event(&amp;button_obj, MTB_HAL_GPIO_IRQ_FALL, <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;\nPress the user button to delete the file or press reset to run the example again.\n\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Wait until the user button press is notified through the interrupt */</span></div>
<div class="line">        <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div>
<div class="line">        {</div>
<div class="line"><span class="preprocessor">#if defined (COMPONENT_RTOS_AWARE)</span></div>
<div class="line">            <span class="keywordflow">if</span>(1UL == ulTaskNotifyTake(pdTRUE, portMAX_DELAY))</div>
<div class="line">            {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">            <span class="keywordflow">if</span>(button_press)</div>
<div class="line">            {</div>
<div class="line">                button_press = <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* #if defined (COMPONENT_RTOS_AWARE) */</span><span class="preprocessor"></span></div>
<div class="line">                cy_rslt_t result;</div>
<div class="line">                <span class="comment">/* Debounce the button press. */</span></div>
<div class="line">                result = mtb_hal_system_delay_ms(DEBOUNCE_DELAY_MS);</div>
<div class="line">                CY_ASSERT(CY_RSLT_SUCCESS != result);</div>
<div class="line">                (void) result;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span>(!mtb_hal_gpio_read(&amp;button_obj)) { <span class="keywordflow">break</span>; }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;Deleting the file... \n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* User button is pressed. Delete the file. */</span></div>
<div class="line">        error = FS_Remove(FILE_NAME);</div>
<div class="line">        check_error(<span class="stringliteral">&quot;Error in deleting the file&quot;</span>, error);</div>
<div class="line"> </div>
<div class="line">        FS_Unmount(volumeName);</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;Filesystem operations completed successfully!\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;Press reset to the run the example again.\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to open the file for writing! Exiting...\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span>(;;)</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add the check error function. <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> check_error(<span class="keywordtype">char</span> *message, <span class="keywordtype">int</span> error)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (error &lt; 0)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n================================================================================\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\nFAIL: %s\n&quot;</span>, message);</div>
<div class="line">        printf(<span class="stringliteral">&quot;Error Value: %d\n&quot;</span>, error);</div>
<div class="line">        printf(<span class="stringliteral">&quot;emFile-defined Error Message: %s&quot;</span>, FS_ErrorNo2Text(error));</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n================================================================================\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">while</span>(<span class="keyword">true</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add the callback function for the user button. <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> user_button_callback(<span class="keywordtype">void</span> *handler_arg, mtb_hal_gpio_event_t event)</div>
<div class="line">{</div>
<div class="line">    (void) handler_arg;</div>
<div class="line">    (void) event;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined(COMPONENT_RTOS_AWARE)</span></div>
<div class="line">    BaseType_t higher_priority_task_woken = pdFALSE;</div>
<div class="line">    vTaskNotifyGiveFromISR(emfile_task_handle, &amp;higher_priority_task_woken);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Yield if xHigherPriorityTaskWoken was set to true */</span></div>
<div class="line">    portYIELD_FROM_ISR(higher_priority_task_woken);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    button_press = <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* #if defined(COMPONENT_RTOS_AWARE) */</span><span class="preprocessor"></span></div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add the interrupt handler for the user button. <div class="fragment"><div class="line"><span class="keywordtype">void</span> btn_isr(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    mtb_hal_gpio_process_interrupt(&amp;button_obj);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add the function for the initialization user button. <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> btn_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    cy_en_sysint_status_t  pdl_sysint_status;</div>
<div class="line">    <span class="comment">/* Initialize the user button used for erasing the block device. */</span></div>
<div class="line">    mtb_hal_gpio_setup(&amp;button_obj, CYBSP_USER_BTN_PORT_NUM, CYBSP_USER_BTN_PIN);</div>
<div class="line">    mtb_hal_gpio_configure(&amp;button_obj, MTB_HAL_GPIO_DIR_INPUT, MTB_HAL_GPIO_DRIVE_PULLUP);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Configure &amp; the user button interrupt */</span></div>
<div class="line">    mtb_hal_gpio_register_callback(&amp;button_obj, user_button_callback, NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Configure interrupt for button */</span></div>
<div class="line">    cy_stc_sysint_t btn_isr_config =</div>
<div class="line">    {</div>
<div class="line">        .intrSrc = CYBSP_USER_BTN_IRQ,</div>
<div class="line">        .intrPriority = 3U</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    pdl_sysint_status = Cy_SysInt_Init(&amp;btn_isr_config, btn_isr);</div>
<div class="line">    <span class="keywordflow">if</span> (CY_SYSINT_SUCCESS != pdl_sysint_status)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Cy_SysInt_Init returns error status\n\r&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    NVIC_EnableIRQ((IRQn_Type) btn_isr_config.intrSrc);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Update main.c. <div class="fragment"><div class="line">    <span class="comment">/* Initialize retarget-io to use the debug UART port */</span></div>
<div class="line">    retarget_io_init();</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;************* &quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;emFile FAT Filesystem&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;************* \n\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined (COMPONENT_RTOS_AWARE)</span></div>
<div class="line">    <span class="comment">/* Create the user tasks. See the respective task definition for more</span></div>
<div class="line"><span class="comment">     * details of these tasks.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    xTaskCreate(emfile_task, <span class="stringliteral">&quot;emFile Task&quot;</span>, EMFILE_TASK_STACK_SIZE,</div>
<div class="line">                NULL, (configMAX_PRIORITIES - 1), &amp;emfile_task_handle);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Start the RTOS scheduler. This function should never return */</span></div>
<div class="line">    vTaskStartScheduler();</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    emfile_task(NULL);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* #if defined (COMPONENT_RTOS_AWARE) */</span><span class="preprocessor"></span></div>
</div><!-- fragment --></li>
</ol>
<p ><b>retarget-io configuration</b></p><ol type="1">
<li>Add the retarget-io configuration function. <div class="fragment"><div class="line"><span class="keywordtype">void</span> retarget_io_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    cy_rslt_t result;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> cy_stc_scb_uart_context_t  DEBUG_UART_context;</div>
<div class="line">    <span class="keyword">static</span> mtb_hal_uart_t             DEBUG_UART_hal_obj;</div>
<div class="line"> </div>
<div class="line">    result = (cy_rslt_t)Cy_SCB_UART_Init(DEBUG_UART_HW, &amp;DEBUG_UART_config, &amp;DEBUG_UART_context);</div>
<div class="line">    <span class="keywordflow">if</span> (result != CY_RSLT_SUCCESS)</div>
<div class="line">    {</div>
<div class="line">        CY_ASSERT(0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    Cy_SCB_UART_Enable(DEBUG_UART_HW);</div>
<div class="line"> </div>
<div class="line">    result = mtb_hal_uart_setup(&amp;DEBUG_UART_hal_obj, &amp;DEBUG_UART_hal_config, &amp;DEBUG_UART_context, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (result != CY_RSLT_SUCCESS)</div>
<div class="line">    {</div>
<div class="line">        CY_ASSERT(0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    result = cy_retarget_io_init(&amp;DEBUG_UART_hal_obj);</div>
<div class="line">    <span class="keywordflow">if</span> (result != CY_RSLT_SUCCESS)</div>
<div class="line">    {</div>
<div class="line">        CY_ASSERT(0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* \x1b[2J\x1b[;H - ANSI ESC sequence for clear screen */</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;\x1b[2J\x1b[;H&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;Retarget-io is configured\n\r&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="section_qsg_project_execution"></a>
Project execution</h2>
<ol type="1">
<li>Open a serial terminal. Set the serial port parameters to 8N1 and 115200 baud.</li>
<li>Build and program the project.</li>
<li>If the previous steps were correct, the logs will appear in the serial terminal.</li>
<li>This example initializes the emfile file system on the target memory device. Create a file and write data to this file. Click the user button, to delete the file.</li>
</ol>
<h1><a class="anchor" id="section_config_cons"></a>
Configuration Considerations</h1>
<h2><a class="anchor" id="section_pick_lib"></a>
Picking an emFile Library Variant</h2>
<p >The Middleware provides emFile as pre-build libraries. The pre-build libraries are selected automatically based on configurations of Makefile configurations. The table below shows the availability of the configuration options.</p>
<table class="doxtable">
<tr>
<th>Configuration</th><th>Options</th><th>Make Variable </th></tr>
<tr>
<td>FAT32/FAT16/FAT12 support </td><td><code>EMFILE_FAT32</code>, <code>EMFILE_FAT16</code> </td><td><code>COMPONENTS</code>  </td></tr>
<tr>
<td>Core </td><td><code>CM4</code>, <code>CM33</code>, <code>CM55</code> </td><td><code>CORE</code>  </td></tr>
<tr>
<td>Floating point </td><td><code>HARDFP</code>, <code>SOFTFP</code> </td><td><code>VFP_SELECT</code>  </td></tr>
<tr>
<td>Toolchain </td><td><code>GCC_ARM</code>, <code>IAR</code>, <code>ARM</code>, <code>LLVM_ARM</code> </td><td><code>TOOLCHAIN</code>  </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>FAT16 option support both FAT16 and FAT12</dd></dl>
<h2><a class="anchor" id="section_rtos"></a>
Using emFile in an RTOS Environment</h2>
<p >The OS layer and the HW layer implementations use the <a href="https://github.com/infineon/abstraction-rtos">abstraction-rtos</a> library for implementing RTOS functionalities. Therefore, emFile can be used with the RTOSes supported by the abstraction-rtos library. Do the following to configure your application for using emFile with FreeRTOS.</p>
<h2><a class="anchor" id="section_nor_driver"></a>
Configuring the HW Layer for the Block Map NOR Driver (NOR_BM)</h2>
<p >Configure the HW layer for the Block Map NOR driver in <code>FS_X_AddDevices()</code> before adding the driver using <code>FS_AddDevice()</code>. A configuration example is present in the import folder of your application or in export/config folder in the emFile middleware. To use this template file, add the <em>EMFILE_NOR_FLASH</em> value to the <em>COMPONENTS</em> variable in the Makefile.</p>
<p >The template file has the weak FS_NOR_HW_SPIFI_ConfigureHw() function to be implemented in the user application. The HW configuration of the used peripheral must be done in this function. An HW configuration example can be found in in Quick Start Guide.</p>
<dl class="section note"><dt>Note</dt><dd>The NOR HW layer supports up to four memories using four slave select pins but all the memories need to be connected to the same data lines.</dd></dl>
<h3><a class="anchor" id="section_nor_driver_xip"></a>
XIP support</h3>
<p >Enable the XIP support to use the same non-volatile memory for code execution and emFile.</p>
<p >To enable the XIP support:</p><ol type="1">
<li>Add ENABLE_XIP_EMFILE_ON_SAME_NOR_FLASH to the define variable in Makefile.</li>
<li>Update the linker script: Put FS_NOR_HW_SPIFI.o and FS_ConfigNOR_BM_SPIFI.o to the memory space, which is not located on the target memory for emFile and the memory, which is not connected to the same SMIF instance. These files can be also located in SRAM. Ensure that SysLib, SMIF, and Memory SPI drivers source files are also in the same sections.</li>
<li>Implement the functions, which block code execution until the non-volatile memory operation completes. This function example is in the FS_ConfigNOR_BM_SPIFI.c file.</li>
<li>Provide the buffers to store data for logic sectors and parameters in SRAM.</li>
</ol>
<p >The XIP support limit some of the functionalities:</p><ul>
<li>In RTOS-environment, asynchronous read/write operations with memory are not supported</li>
<li>The emFile enters the critical section (Disable all interrupts) when any read/write/erase operations are started and exits after their completion. <dl class="section note"><dt>Note</dt><dd>If the XIP support is enabled on a multi-core system and other cores use the same memory for code execution, the other cores may not have access to the memory during the write/erase operations.</dd></dl>
</li>
</ul>
<h2><a class="anchor" id="section_sd_card_driver"></a>
Configuring the HW Layer for the SD/MMC driver</h2>
<p >Configure the HW layer for the SD/MMC driver in <code>FS_X_AddDevices()</code> before adding the driver using <code>FS_AddDevice()</code>. The example of configuration is present in import folder of your application or in export/config folder in the emFile middleware. To use this template file, add the <em>EMFILE_SD_CARD</em> value to <em>COMPONENTS</em> variable in the Makefile.</p>
<p >The template file has the weak FS_MMC_HW_CM_ConfigureHw() function to be implemented in the user application. In this function, the HW configuration of the used peripheral must be done. A HW configuration example can be found in Quick Start Guide.</p>
<h1><a class="anchor" id="section_package_str"></a>
emFile Package Structure</h1>
<p >The Middleware structure:</p><ul>
<li><b>export/Config:</b> Contains sample configuration files for emFile drivers.</li>
<li><b>OS:</b> Contains the OS layer implementation.</li>
<li><b>FS:</b> Contains a set of pre-build emFile libraries for different configurations of user applications (Device family, Build configuration, Core, Floating point, Toolchain), and a set of header files.</li>
<li><b>Driver:</b> Contains the Drivers implementation.</li>
<li><b>docs:</b> Contains the API Reference Guide, SEGGER-provided emFile User Guide &amp; Reference Manual and other supporting documentation.</li>
</ul>
<h1><a class="anchor" id="section_changelog"></a>
Changelog</h1>
<table class="doxtable">
<tr>
<th>Version</th><th>Changes</th><th>Reason for Change </th></tr>
<tr>
<td>3.0.0 </td><td>emFile is migrated to HAL-Next flow </td><td></td></tr>
</table>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>SEGGER emFile for ModusToolbox</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
-->
</body>
</html>
